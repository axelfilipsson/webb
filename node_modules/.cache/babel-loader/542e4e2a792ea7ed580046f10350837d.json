{"ast":null,"code":"import { Vector3, Vector4 } from 'three';\n/**\n * NURBS utils\n *\n * See NURBSCurve and NURBSSurface.\n **/\n\n/**************************************************************\n *\tNURBS Utils\n **************************************************************/\n\n/*\nFinds knot vector span.\n\np : degree\nu : parametric value\nU : knot vector\n\nreturns the span\n*/\n\nfunction findSpan(p, u, U) {\n  const n = U.length - p - 1;\n\n  if (u >= U[n]) {\n    return n - 1;\n  }\n\n  if (u <= U[p]) {\n    return p;\n  }\n\n  let low = p;\n  let high = n;\n  let mid = Math.floor((low + high) / 2);\n\n  while (u < U[mid] || u >= U[mid + 1]) {\n    if (u < U[mid]) {\n      high = mid;\n    } else {\n      low = mid;\n    }\n\n    mid = Math.floor((low + high) / 2);\n  }\n\n  return mid;\n}\n/*\nCalculate basis functions. See The NURBS Book, page 70, algorithm A2.2\n\nspan : span in which u lies\nu    : parametric point\np    : degree\nU    : knot vector\n\nreturns array[p+1] with basis functions values.\n*/\n\n\nfunction calcBasisFunctions(span, u, p, U) {\n  const N = [];\n  const left = [];\n  const right = [];\n  N[0] = 1.0;\n\n  for (let j = 1; j <= p; ++j) {\n    left[j] = u - U[span + 1 - j];\n    right[j] = U[span + j] - u;\n    let saved = 0.0;\n\n    for (let r = 0; r < j; ++r) {\n      const rv = right[r + 1];\n      const lv = left[j - r];\n      const temp = N[r] / (rv + lv);\n      N[r] = saved + rv * temp;\n      saved = lv * temp;\n    }\n\n    N[j] = saved;\n  }\n\n  return N;\n}\n/*\nCalculate B-Spline curve points. See The NURBS Book, page 82, algorithm A3.1.\n\np : degree of B-Spline\nU : knot vector\nP : control points (x, y, z, w)\nu : parametric point\n\nreturns point for given u\n*/\n\n\nfunction calcBSplinePoint(p, U, P, u) {\n  const span = findSpan(p, u, U);\n  const N = calcBasisFunctions(span, u, p, U);\n  const C = new Vector4(0, 0, 0, 0);\n\n  for (let j = 0; j <= p; ++j) {\n    const point = P[span - p + j];\n    const Nj = N[j];\n    const wNj = point.w * Nj;\n    C.x += point.x * wNj;\n    C.y += point.y * wNj;\n    C.z += point.z * wNj;\n    C.w += point.w * Nj;\n  }\n\n  return C;\n}\n/*\nCalculate basis functions derivatives. See The NURBS Book, page 72, algorithm A2.3.\n\nspan : span in which u lies\nu    : parametric point\np    : degree\nn    : number of derivatives to calculate\nU    : knot vector\n\nreturns array[n+1][p+1] with basis functions derivatives\n*/\n\n\nfunction calcBasisFunctionDerivatives(span, u, p, n, U) {\n  const zeroArr = [];\n\n  for (let i = 0; i <= p; ++i) zeroArr[i] = 0.0;\n\n  const ders = [];\n\n  for (let i = 0; i <= n; ++i) ders[i] = zeroArr.slice(0);\n\n  const ndu = [];\n\n  for (let i = 0; i <= p; ++i) ndu[i] = zeroArr.slice(0);\n\n  ndu[0][0] = 1.0;\n  const left = zeroArr.slice(0);\n  const right = zeroArr.slice(0);\n\n  for (let j = 1; j <= p; ++j) {\n    left[j] = u - U[span + 1 - j];\n    right[j] = U[span + j] - u;\n    let saved = 0.0;\n\n    for (let r = 0; r < j; ++r) {\n      const rv = right[r + 1];\n      const lv = left[j - r];\n      ndu[j][r] = rv + lv;\n      const temp = ndu[r][j - 1] / ndu[j][r];\n      ndu[r][j] = saved + rv * temp;\n      saved = lv * temp;\n    }\n\n    ndu[j][j] = saved;\n  }\n\n  for (let j = 0; j <= p; ++j) {\n    ders[0][j] = ndu[j][p];\n  }\n\n  for (let r = 0; r <= p; ++r) {\n    let s1 = 0;\n    let s2 = 1;\n    const a = [];\n\n    for (let i = 0; i <= p; ++i) {\n      a[i] = zeroArr.slice(0);\n    }\n\n    a[0][0] = 1.0;\n\n    for (let k = 1; k <= n; ++k) {\n      let d = 0.0;\n      const rk = r - k;\n      const pk = p - k;\n\n      if (r >= k) {\n        a[s2][0] = a[s1][0] / ndu[pk + 1][rk];\n        d = a[s2][0] * ndu[rk][pk];\n      }\n\n      const j1 = rk >= -1 ? 1 : -rk;\n      const j2 = r - 1 <= pk ? k - 1 : p - r;\n\n      for (let j = j1; j <= j2; ++j) {\n        a[s2][j] = (a[s1][j] - a[s1][j - 1]) / ndu[pk + 1][rk + j];\n        d += a[s2][j] * ndu[rk + j][pk];\n      }\n\n      if (r <= pk) {\n        a[s2][k] = -a[s1][k - 1] / ndu[pk + 1][r];\n        d += a[s2][k] * ndu[r][pk];\n      }\n\n      ders[k][r] = d;\n      const j = s1;\n      s1 = s2;\n      s2 = j;\n    }\n  }\n\n  let r = p;\n\n  for (let k = 1; k <= n; ++k) {\n    for (let j = 0; j <= p; ++j) {\n      ders[k][j] *= r;\n    }\n\n    r *= p - k;\n  }\n\n  return ders;\n}\n/*\n\tCalculate derivatives of a B-Spline. See The NURBS Book, page 93, algorithm A3.2.\n\n\tp  : degree\n\tU  : knot vector\n\tP  : control points\n\tu  : Parametric points\n\tnd : number of derivatives\n\n\treturns array[d+1] with derivatives\n\t*/\n\n\nfunction calcBSplineDerivatives(p, U, P, u, nd) {\n  const du = nd < p ? nd : p;\n  const CK = [];\n  const span = findSpan(p, u, U);\n  const nders = calcBasisFunctionDerivatives(span, u, p, du, U);\n  const Pw = [];\n\n  for (let i = 0; i < P.length; ++i) {\n    const point = P[i].clone();\n    const w = point.w;\n    point.x *= w;\n    point.y *= w;\n    point.z *= w;\n    Pw[i] = point;\n  }\n\n  for (let k = 0; k <= du; ++k) {\n    const point = Pw[span - p].clone().multiplyScalar(nders[k][0]);\n\n    for (let j = 1; j <= p; ++j) {\n      point.add(Pw[span - p + j].clone().multiplyScalar(nders[k][j]));\n    }\n\n    CK[k] = point;\n  }\n\n  for (let k = du + 1; k <= nd + 1; ++k) {\n    CK[k] = new Vector4(0, 0, 0);\n  }\n\n  return CK;\n}\n/*\nCalculate \"K over I\"\n\nreturns k!/(i!(k-i)!)\n*/\n\n\nfunction calcKoverI(k, i) {\n  let nom = 1;\n\n  for (let j = 2; j <= k; ++j) {\n    nom *= j;\n  }\n\n  let denom = 1;\n\n  for (let j = 2; j <= i; ++j) {\n    denom *= j;\n  }\n\n  for (let j = 2; j <= k - i; ++j) {\n    denom *= j;\n  }\n\n  return nom / denom;\n}\n/*\nCalculate derivatives (0-nd) of rational curve. See The NURBS Book, page 127, algorithm A4.2.\n\nPders : result of function calcBSplineDerivatives\n\nreturns array with derivatives for rational curve.\n*/\n\n\nfunction calcRationalCurveDerivatives(Pders) {\n  const nd = Pders.length;\n  const Aders = [];\n  const wders = [];\n\n  for (let i = 0; i < nd; ++i) {\n    const point = Pders[i];\n    Aders[i] = new Vector3(point.x, point.y, point.z);\n    wders[i] = point.w;\n  }\n\n  const CK = [];\n\n  for (let k = 0; k < nd; ++k) {\n    const v = Aders[k].clone();\n\n    for (let i = 1; i <= k; ++i) {\n      v.sub(CK[k - i].clone().multiplyScalar(calcKoverI(k, i) * wders[i]));\n    }\n\n    CK[k] = v.divideScalar(wders[0]);\n  }\n\n  return CK;\n}\n/*\nCalculate NURBS curve derivatives. See The NURBS Book, page 127, algorithm A4.2.\n\np  : degree\nU  : knot vector\nP  : control points in homogeneous space\nu  : parametric points\nnd : number of derivatives\n\nreturns array with derivatives.\n*/\n\n\nfunction calcNURBSDerivatives(p, U, P, u, nd) {\n  const Pders = calcBSplineDerivatives(p, U, P, u, nd);\n  return calcRationalCurveDerivatives(Pders);\n}\n/*\nCalculate rational B-Spline surface point. See The NURBS Book, page 134, algorithm A4.3.\n\np1, p2 : degrees of B-Spline surface\nU1, U2 : knot vectors\nP      : control points (x, y, z, w)\nu, v   : parametric values\n\nreturns point for given (u, v)\n*/\n\n\nfunction calcSurfacePoint(p, q, U, V, P, u, v, target) {\n  const uspan = findSpan(p, u, U);\n  const vspan = findSpan(q, v, V);\n  const Nu = calcBasisFunctions(uspan, u, p, U);\n  const Nv = calcBasisFunctions(vspan, v, q, V);\n  const temp = [];\n\n  for (let l = 0; l <= q; ++l) {\n    temp[l] = new Vector4(0, 0, 0, 0);\n\n    for (let k = 0; k <= p; ++k) {\n      const point = P[uspan - p + k][vspan - q + l].clone();\n      const w = point.w;\n      point.x *= w;\n      point.y *= w;\n      point.z *= w;\n      temp[l].add(point.multiplyScalar(Nu[k]));\n    }\n  }\n\n  const Sw = new Vector4(0, 0, 0, 0);\n\n  for (let l = 0; l <= q; ++l) {\n    Sw.add(temp[l].multiplyScalar(Nv[l]));\n  }\n\n  Sw.divideScalar(Sw.w);\n  target.set(Sw.x, Sw.y, Sw.z);\n}\n\nexport { findSpan, calcBasisFunctions, calcBSplinePoint, calcBasisFunctionDerivatives, calcBSplineDerivatives, calcKoverI, calcRationalCurveDerivatives, calcNURBSDerivatives, calcSurfacePoint };","map":{"version":3,"sources":["/Users/axel/programmering/axel-filipsson-website/node_modules/three/examples/jsm/curves/NURBSUtils.js"],"names":["Vector3","Vector4","findSpan","p","u","U","n","length","low","high","mid","Math","floor","calcBasisFunctions","span","N","left","right","j","saved","r","rv","lv","temp","calcBSplinePoint","P","C","point","Nj","wNj","w","x","y","z","calcBasisFunctionDerivatives","zeroArr","i","ders","slice","ndu","s1","s2","a","k","d","rk","pk","j1","j2","calcBSplineDerivatives","nd","du","CK","nders","Pw","clone","multiplyScalar","add","calcKoverI","nom","denom","calcRationalCurveDerivatives","Pders","Aders","wders","v","sub","divideScalar","calcNURBSDerivatives","calcSurfacePoint","q","V","target","uspan","vspan","Nu","Nv","l","Sw","set"],"mappings":"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","sourcesContent":["import {\n\tVector3,\n\tVector4\n} from 'three';\n\n/**\n * NURBS utils\n *\n * See NURBSCurve and NURBSSurface.\n **/\n\n\n/**************************************************************\n *\tNURBS Utils\n **************************************************************/\n\n/*\nFinds knot vector span.\n\np : degree\nu : parametric value\nU : knot vector\n\nreturns the span\n*/\nfunction findSpan( p, u, U ) {\n\n\tconst n = U.length - p - 1;\n\n\tif ( u >= U[ n ] ) {\n\n\t\treturn n - 1;\n\n\t}\n\n\tif ( u <= U[ p ] ) {\n\n\t\treturn p;\n\n\t}\n\n\tlet low = p;\n\tlet high = n;\n\tlet mid = Math.floor( ( low + high ) / 2 );\n\n\twhile ( u < U[ mid ] || u >= U[ mid + 1 ] ) {\n\n\t\tif ( u < U[ mid ] ) {\n\n\t\t\thigh = mid;\n\n\t\t} else {\n\n\t\t\tlow = mid;\n\n\t\t}\n\n\t\tmid = Math.floor( ( low + high ) / 2 );\n\n\t}\n\n\treturn mid;\n\n}\n\n\n/*\nCalculate basis functions. See The NURBS Book, page 70, algorithm A2.2\n\nspan : span in which u lies\nu    : parametric point\np    : degree\nU    : knot vector\n\nreturns array[p+1] with basis functions values.\n*/\nfunction calcBasisFunctions( span, u, p, U ) {\n\n\tconst N = [];\n\tconst left = [];\n\tconst right = [];\n\tN[ 0 ] = 1.0;\n\n\tfor ( let j = 1; j <= p; ++ j ) {\n\n\t\tleft[ j ] = u - U[ span + 1 - j ];\n\t\tright[ j ] = U[ span + j ] - u;\n\n\t\tlet saved = 0.0;\n\n\t\tfor ( let r = 0; r < j; ++ r ) {\n\n\t\t\tconst rv = right[ r + 1 ];\n\t\t\tconst lv = left[ j - r ];\n\t\t\tconst temp = N[ r ] / ( rv + lv );\n\t\t\tN[ r ] = saved + rv * temp;\n\t\t\tsaved = lv * temp;\n\n\t\t}\n\n\t\tN[ j ] = saved;\n\n\t}\n\n\treturn N;\n\n}\n\n\n/*\nCalculate B-Spline curve points. See The NURBS Book, page 82, algorithm A3.1.\n\np : degree of B-Spline\nU : knot vector\nP : control points (x, y, z, w)\nu : parametric point\n\nreturns point for given u\n*/\nfunction calcBSplinePoint( p, U, P, u ) {\n\n\tconst span = findSpan( p, u, U );\n\tconst N = calcBasisFunctions( span, u, p, U );\n\tconst C = new Vector4( 0, 0, 0, 0 );\n\n\tfor ( let j = 0; j <= p; ++ j ) {\n\n\t\tconst point = P[ span - p + j ];\n\t\tconst Nj = N[ j ];\n\t\tconst wNj = point.w * Nj;\n\t\tC.x += point.x * wNj;\n\t\tC.y += point.y * wNj;\n\t\tC.z += point.z * wNj;\n\t\tC.w += point.w * Nj;\n\n\t}\n\n\treturn C;\n\n}\n\n\n/*\nCalculate basis functions derivatives. See The NURBS Book, page 72, algorithm A2.3.\n\nspan : span in which u lies\nu    : parametric point\np    : degree\nn    : number of derivatives to calculate\nU    : knot vector\n\nreturns array[n+1][p+1] with basis functions derivatives\n*/\nfunction calcBasisFunctionDerivatives( span, u, p, n, U ) {\n\n\tconst zeroArr = [];\n\tfor ( let i = 0; i <= p; ++ i )\n\t\tzeroArr[ i ] = 0.0;\n\n\tconst ders = [];\n\n\tfor ( let i = 0; i <= n; ++ i )\n\t\tders[ i ] = zeroArr.slice( 0 );\n\n\tconst ndu = [];\n\n\tfor ( let i = 0; i <= p; ++ i )\n\t\tndu[ i ] = zeroArr.slice( 0 );\n\n\tndu[ 0 ][ 0 ] = 1.0;\n\n\tconst left = zeroArr.slice( 0 );\n\tconst right = zeroArr.slice( 0 );\n\n\tfor ( let j = 1; j <= p; ++ j ) {\n\n\t\tleft[ j ] = u - U[ span + 1 - j ];\n\t\tright[ j ] = U[ span + j ] - u;\n\n\t\tlet saved = 0.0;\n\n\t\tfor ( let r = 0; r < j; ++ r ) {\n\n\t\t\tconst rv = right[ r + 1 ];\n\t\t\tconst lv = left[ j - r ];\n\t\t\tndu[ j ][ r ] = rv + lv;\n\n\t\t\tconst temp = ndu[ r ][ j - 1 ] / ndu[ j ][ r ];\n\t\t\tndu[ r ][ j ] = saved + rv * temp;\n\t\t\tsaved = lv * temp;\n\n\t\t}\n\n\t\tndu[ j ][ j ] = saved;\n\n\t}\n\n\tfor ( let j = 0; j <= p; ++ j ) {\n\n\t\tders[ 0 ][ j ] = ndu[ j ][ p ];\n\n\t}\n\n\tfor ( let r = 0; r <= p; ++ r ) {\n\n\t\tlet s1 = 0;\n\t\tlet s2 = 1;\n\n\t\tconst a = [];\n\t\tfor ( let i = 0; i <= p; ++ i ) {\n\n\t\t\ta[ i ] = zeroArr.slice( 0 );\n\n\t\t}\n\n\t\ta[ 0 ][ 0 ] = 1.0;\n\n\t\tfor ( let k = 1; k <= n; ++ k ) {\n\n\t\t\tlet d = 0.0;\n\t\t\tconst rk = r - k;\n\t\t\tconst pk = p - k;\n\n\t\t\tif ( r >= k ) {\n\n\t\t\t\ta[ s2 ][ 0 ] = a[ s1 ][ 0 ] / ndu[ pk + 1 ][ rk ];\n\t\t\t\td = a[ s2 ][ 0 ] * ndu[ rk ][ pk ];\n\n\t\t\t}\n\n\t\t\tconst j1 = ( rk >= - 1 ) ? 1 : - rk;\n\t\t\tconst j2 = ( r - 1 <= pk ) ? k - 1 : p - r;\n\n\t\t\tfor ( let j = j1; j <= j2; ++ j ) {\n\n\t\t\t\ta[ s2 ][ j ] = ( a[ s1 ][ j ] - a[ s1 ][ j - 1 ] ) / ndu[ pk + 1 ][ rk + j ];\n\t\t\t\td += a[ s2 ][ j ] * ndu[ rk + j ][ pk ];\n\n\t\t\t}\n\n\t\t\tif ( r <= pk ) {\n\n\t\t\t\ta[ s2 ][ k ] = - a[ s1 ][ k - 1 ] / ndu[ pk + 1 ][ r ];\n\t\t\t\td += a[ s2 ][ k ] * ndu[ r ][ pk ];\n\n\t\t\t}\n\n\t\t\tders[ k ][ r ] = d;\n\n\t\t\tconst j = s1;\n\t\t\ts1 = s2;\n\t\t\ts2 = j;\n\n\t\t}\n\n\t}\n\n\tlet r = p;\n\n\tfor ( let k = 1; k <= n; ++ k ) {\n\n\t\tfor ( let j = 0; j <= p; ++ j ) {\n\n\t\t\tders[ k ][ j ] *= r;\n\n\t\t}\n\n\t\tr *= p - k;\n\n\t}\n\n\treturn ders;\n\n}\n\n\n/*\n\tCalculate derivatives of a B-Spline. See The NURBS Book, page 93, algorithm A3.2.\n\n\tp  : degree\n\tU  : knot vector\n\tP  : control points\n\tu  : Parametric points\n\tnd : number of derivatives\n\n\treturns array[d+1] with derivatives\n\t*/\nfunction calcBSplineDerivatives( p, U, P, u, nd ) {\n\n\tconst du = nd < p ? nd : p;\n\tconst CK = [];\n\tconst span = findSpan( p, u, U );\n\tconst nders = calcBasisFunctionDerivatives( span, u, p, du, U );\n\tconst Pw = [];\n\n\tfor ( let i = 0; i < P.length; ++ i ) {\n\n\t\tconst point = P[ i ].clone();\n\t\tconst w = point.w;\n\n\t\tpoint.x *= w;\n\t\tpoint.y *= w;\n\t\tpoint.z *= w;\n\n\t\tPw[ i ] = point;\n\n\t}\n\n\tfor ( let k = 0; k <= du; ++ k ) {\n\n\t\tconst point = Pw[ span - p ].clone().multiplyScalar( nders[ k ][ 0 ] );\n\n\t\tfor ( let j = 1; j <= p; ++ j ) {\n\n\t\t\tpoint.add( Pw[ span - p + j ].clone().multiplyScalar( nders[ k ][ j ] ) );\n\n\t\t}\n\n\t\tCK[ k ] = point;\n\n\t}\n\n\tfor ( let k = du + 1; k <= nd + 1; ++ k ) {\n\n\t\tCK[ k ] = new Vector4( 0, 0, 0 );\n\n\t}\n\n\treturn CK;\n\n}\n\n\n/*\nCalculate \"K over I\"\n\nreturns k!/(i!(k-i)!)\n*/\nfunction calcKoverI( k, i ) {\n\n\tlet nom = 1;\n\n\tfor ( let j = 2; j <= k; ++ j ) {\n\n\t\tnom *= j;\n\n\t}\n\n\tlet denom = 1;\n\n\tfor ( let j = 2; j <= i; ++ j ) {\n\n\t\tdenom *= j;\n\n\t}\n\n\tfor ( let j = 2; j <= k - i; ++ j ) {\n\n\t\tdenom *= j;\n\n\t}\n\n\treturn nom / denom;\n\n}\n\n\n/*\nCalculate derivatives (0-nd) of rational curve. See The NURBS Book, page 127, algorithm A4.2.\n\nPders : result of function calcBSplineDerivatives\n\nreturns array with derivatives for rational curve.\n*/\nfunction calcRationalCurveDerivatives( Pders ) {\n\n\tconst nd = Pders.length;\n\tconst Aders = [];\n\tconst wders = [];\n\n\tfor ( let i = 0; i < nd; ++ i ) {\n\n\t\tconst point = Pders[ i ];\n\t\tAders[ i ] = new Vector3( point.x, point.y, point.z );\n\t\twders[ i ] = point.w;\n\n\t}\n\n\tconst CK = [];\n\n\tfor ( let k = 0; k < nd; ++ k ) {\n\n\t\tconst v = Aders[ k ].clone();\n\n\t\tfor ( let i = 1; i <= k; ++ i ) {\n\n\t\t\tv.sub( CK[ k - i ].clone().multiplyScalar( calcKoverI( k, i ) * wders[ i ] ) );\n\n\t\t}\n\n\t\tCK[ k ] = v.divideScalar( wders[ 0 ] );\n\n\t}\n\n\treturn CK;\n\n}\n\n\n/*\nCalculate NURBS curve derivatives. See The NURBS Book, page 127, algorithm A4.2.\n\np  : degree\nU  : knot vector\nP  : control points in homogeneous space\nu  : parametric points\nnd : number of derivatives\n\nreturns array with derivatives.\n*/\nfunction calcNURBSDerivatives( p, U, P, u, nd ) {\n\n\tconst Pders = calcBSplineDerivatives( p, U, P, u, nd );\n\treturn calcRationalCurveDerivatives( Pders );\n\n}\n\n\n/*\nCalculate rational B-Spline surface point. See The NURBS Book, page 134, algorithm A4.3.\n\np1, p2 : degrees of B-Spline surface\nU1, U2 : knot vectors\nP      : control points (x, y, z, w)\nu, v   : parametric values\n\nreturns point for given (u, v)\n*/\nfunction calcSurfacePoint( p, q, U, V, P, u, v, target ) {\n\n\tconst uspan = findSpan( p, u, U );\n\tconst vspan = findSpan( q, v, V );\n\tconst Nu = calcBasisFunctions( uspan, u, p, U );\n\tconst Nv = calcBasisFunctions( vspan, v, q, V );\n\tconst temp = [];\n\n\tfor ( let l = 0; l <= q; ++ l ) {\n\n\t\ttemp[ l ] = new Vector4( 0, 0, 0, 0 );\n\t\tfor ( let k = 0; k <= p; ++ k ) {\n\n\t\t\tconst point = P[ uspan - p + k ][ vspan - q + l ].clone();\n\t\t\tconst w = point.w;\n\t\t\tpoint.x *= w;\n\t\t\tpoint.y *= w;\n\t\t\tpoint.z *= w;\n\t\t\ttemp[ l ].add( point.multiplyScalar( Nu[ k ] ) );\n\n\t\t}\n\n\t}\n\n\tconst Sw = new Vector4( 0, 0, 0, 0 );\n\tfor ( let l = 0; l <= q; ++ l ) {\n\n\t\tSw.add( temp[ l ].multiplyScalar( Nv[ l ] ) );\n\n\t}\n\n\tSw.divideScalar( Sw.w );\n\ttarget.set( Sw.x, Sw.y, Sw.z );\n\n}\n\n\n\nexport {\n\tfindSpan,\n\tcalcBasisFunctions,\n\tcalcBSplinePoint,\n\tcalcBasisFunctionDerivatives,\n\tcalcBSplineDerivatives,\n\tcalcKoverI,\n\tcalcRationalCurveDerivatives,\n\tcalcNURBSDerivatives,\n\tcalcSurfacePoint,\n};\n"]},"metadata":{},"sourceType":"module"}